<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LIMINAL SYSTEM // 閾値システム</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@300;400;700&family=Orbitron:wght@400;700;900&display=swap');

:root {
  --bg:       #080a0d;
  --bg2:      #0c0f14;
  --surface:  #0f1318;
  --surface2: #131820;
  --border:   #1a2535;
  --border2:  #243040;
  --accent:   #00e5ff;
  --accent2:  #0099bb;
  --danger:   #ff2d55;
  --warn:     #ffd600;
  --ok:       #00ff88;
  --muted:    #2a3a4a;
  --text:     #c8d8e8;
  --text-dim: #4a6070;
  --text-mid: #8090a0;
  --glow:     rgba(0,229,255,0.12);
  --glow-sm:  rgba(0,229,255,0.06);
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  background:var(--bg);color:var(--text);
  font-family:'Noto Sans JP',sans-serif;font-weight:300;
  min-height:100vh;overflow-x:hidden;
}
button{font-family:inherit;cursor:pointer;}
input,textarea{font-family:'Share Tech Mono',monospace;}
a{text-decoration:none;color:inherit;}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* SCANLINES */
body::before{
  content:'';position:fixed;inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.04) 2px,rgba(0,0,0,.04) 4px);
  pointer-events:none;z-index:9000;
}

/* ─── BOOT ─── */
#boot{
  position:fixed;inset:0;background:#000;z-index:9999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
  transition:opacity .6s;
}
.boot-logo{
  font-family:'Orbitron',monospace;font-size:22px;font-weight:900;
  color:var(--accent);text-shadow:0 0 24px var(--accent);letter-spacing:.35em;
  animation:flickerIn 1.2s ease forwards;
}
.boot-sub{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);letter-spacing:.2em;}
.boot-bar-wrap{width:260px;height:2px;background:#111;}
.boot-bar{height:100%;background:var(--accent);box-shadow:0 0 10px var(--accent);width:0;animation:bootFill 1.8s cubic-bezier(.4,0,.2,1) .3s forwards;}
.boot-msg{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);letter-spacing:.15em;}
@keyframes flickerIn{0%{opacity:0}10%{opacity:.9}15%{opacity:0}20%{opacity:1}25%{opacity:.2}30%{opacity:1}100%{opacity:1}}
@keyframes bootFill{from{width:0}to{width:100%}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes glitchH{0%{clip-path:inset(30% 0 40% 0);transform:translate(-3px)}50%{clip-path:inset(60% 0 10% 0);transform:translate(3px)}100%{clip-path:inset(30% 0 40% 0);transform:translate(-3px)}}

/* ─── SHELL ─── */
.shell{display:flex;min-height:100vh;}

/* ─── SIDEBAR ─── */
.sidebar{
  width:200px;flex-shrink:0;
  background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  position:fixed;top:0;left:0;height:100vh;z-index:200;
  transition:transform .3s;
}
.sidebar-logo{
  padding:22px 20px 16px;border-bottom:1px solid var(--border);position:relative;
}
.sidebar-logo-name{
  font-family:'Orbitron',monospace;font-size:12px;font-weight:900;
  letter-spacing:.2em;color:var(--accent);text-shadow:0 0 10px var(--accent);
}
.sidebar-logo-sub{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:.12em;margin-top:4px;}
.sidebar-logo::after{
  content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;
  background:linear-gradient(90deg,var(--accent),transparent);
  box-shadow:0 0 6px var(--accent);
}
.agent-card{padding:14px 20px;border-bottom:1px solid var(--border);}
.agent-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.2em;color:var(--text-dim);margin-bottom:4px;}
.agent-name{
  font-family:'Orbitron',monospace;font-size:11px;font-weight:700;color:var(--text);
  letter-spacing:.08em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.agent-status{display:flex;align-items:center;gap:5px;margin-top:6px;}
.sdot{width:5px;height:5px;border-radius:50%;background:var(--ok);box-shadow:0 0 5px var(--ok);animation:pulse 2s ease-in-out infinite;}
.stext{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--ok);letter-spacing:.1em;}
.sidebar-nav{flex:1;padding:10px 0;overflow-y:auto;}
.nav-section{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.25em;color:var(--muted);padding:10px 20px 4px;}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:9px 20px;color:var(--text-dim);
  font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.08em;
  border:none;background:none;width:100%;text-align:left;
  border-left:2px solid transparent;transition:all .15s;
  position:relative;
}
.nav-item svg{width:13px;height:13px;opacity:.6;flex-shrink:0;stroke:currentColor;fill:none;stroke-width:1.5;}
.nav-item:hover,.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:linear-gradient(90deg,rgba(0,229,255,.06),transparent);}
.nav-item:hover svg,.nav-item.active svg{opacity:1;}
.nav-badge{
  margin-left:auto;background:var(--danger);color:#fff;
  font-size:7px;padding:2px 4px;border-radius:1px;
  font-family:'Share Tech Mono',monospace;box-shadow:0 0 6px var(--danger);
  animation:pulse 2s ease-in-out infinite;
}
.nav-item.disabled{opacity:.35;pointer-events:none;}
.sidebar-foot{padding:12px 20px;border-top:1px solid var(--border);}
.ver{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--muted);letter-spacing:.08em;}
.copyright{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--muted);margin-top:4px;}

/* ─── MAIN AREA ─── */
.main-area{margin-left:200px;flex:1;display:flex;flex-direction:column;min-height:100vh;}

/* ─── TOPBAR ─── */
.topbar{
  position:sticky;top:0;z-index:100;height:50px;
  background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 24px;gap:16px;
}
.breadcrumb{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);letter-spacing:.1em;flex:1;}
.breadcrumb span{color:var(--accent);}
.topbar-clock{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;color:var(--text-dim);letter-spacing:.12em;}
.topbar-btn{
  background:rgba(255,45,85,.08);border:1px solid rgba(255,45,85,.25);
  color:var(--danger);font-family:'Share Tech Mono',monospace;font-size:9px;
  letter-spacing:.12em;padding:5px 10px;display:flex;align-items:center;gap:5px;transition:all .2s;
}
.topbar-btn:hover{background:rgba(255,45,85,.18);box-shadow:0 0 10px rgba(255,45,85,.2);}
.hamburger{display:none;background:none;border:none;color:var(--text-dim);padding:4px;}
.hamburger svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;}

/* ─── PAGE ─── */
.page{display:none;padding:24px;flex-direction:column;gap:22px;}
.page.active{display:flex;}

/* ─── SECTION ─── */
.sec-hdr{display:flex;align-items:baseline;gap:10px;margin-bottom:14px;}
.sec-title{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:.28em;color:var(--accent);}
.sec-line{flex:1;height:1px;background:linear-gradient(90deg,var(--border2),transparent);}
.sec-count{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);}

/* ─── PANEL ─── */
.panel{background:var(--surface);border:1px solid var(--border);overflow:hidden;}
.panel-hdr{
  padding:10px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  background:rgba(0,0,0,.25);
}
.panel-title{font-family:'Orbitron',monospace;font-size:9px;font-weight:700;letter-spacing:.2em;color:var(--accent);}
.panel-sub{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:.08em;display:flex;align-items:center;gap:5px;}
.live-dot{width:5px;height:5px;border-radius:50%;background:var(--danger);box-shadow:0 0 5px var(--danger);animation:pulse 1.2s ease-in-out infinite;}
.panel-body{padding:16px;}

/* ─── STAT CARDS ─── */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
.stat-card{
  background:var(--surface);border:1px solid var(--border);
  padding:14px 16px;position:relative;overflow:hidden;transition:border-color .25s;
}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0;transition:opacity .25s;}
.stat-card:hover{border-color:var(--accent);}
.stat-card:hover::before{opacity:1;}
.stat-lbl{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.18em;color:var(--text-dim);margin-bottom:6px;}
.stat-val{font-family:'Orbitron',monospace;font-size:26px;font-weight:900;color:var(--text);line-height:1;}
.stat-val.c-accent{color:var(--accent);text-shadow:0 0 10px var(--accent);}
.stat-val.c-danger{color:var(--danger);text-shadow:0 0 10px var(--danger);}
.stat-val.c-warn{color:var(--warn);text-shadow:0 0 10px var(--warn);}
.stat-val.c-ok{color:var(--ok);text-shadow:0 0 10px var(--ok);}
.stat-sub{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--muted);margin-top:4px;letter-spacing:.06em;}

/* ─── CAROUSEL (CONNECTED) ─── */
.carousel-wrap{position:relative;overflow:hidden;}
.carousel-track{display:flex;gap:10px;transition:transform .35s cubic-bezier(.4,0,.2,1);padding-bottom:4px;}
.carousel-nav{display:flex;justify-content:center;gap:6px;margin-top:10px;}
.carousel-dot{width:6px;height:6px;border-radius:50%;background:var(--border2);border:none;cursor:pointer;transition:all .2s;}
.carousel-dot.active{background:var(--accent);box-shadow:0 0 6px var(--accent);}
.carousel-arrows{display:flex;gap:8px;margin-top:10px;justify-content:flex-end;}
.carr-btn{
  background:var(--surface);border:1px solid var(--border);
  color:var(--text-dim);padding:6px 10px;font-family:'Share Tech Mono',monospace;font-size:11px;
  transition:all .2s;
}
.carr-btn:hover{border-color:var(--accent);color:var(--accent);}

/* ─── CASE CARD ─── */
.case-card{
  background:var(--surface2);border:1px solid var(--border);
  overflow:hidden;position:relative;cursor:pointer;transition:all .25s;
  flex-shrink:0;
}
.case-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,229,255,.08);}
.case-card.locked{opacity:.45;cursor:not-allowed;filter:grayscale(.6);}
.case-card.locked:hover{transform:none;box-shadow:none;border-color:var(--border);}
.case-thumb{
  width:100%;aspect-ratio:1/1;background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  font-family:'Orbitron',monospace;font-size:28px;font-weight:900;
  color:var(--border2);position:relative;overflow:hidden;
}
.case-thumb img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;}
.case-thumb-overlay{position:absolute;inset:0;background:linear-gradient(to bottom,transparent 50%,rgba(0,0,0,.6));pointer-events:none;}
.case-progress{position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--muted);}
.case-progress-fill{height:100%;background:var(--accent);box-shadow:0 0 6px var(--accent);transition:width 1s ease;}
.case-progress-fill.warn{background:var(--warn);box-shadow:0 0 6px var(--warn);}
.case-progress-fill.danger{background:var(--danger);box-shadow:0 0 6px var(--danger);}
.case-progress-fill.ok{background:var(--ok);box-shadow:0 0 6px var(--ok);}
.case-body{padding:10px 12px 12px;}
.case-tags{display:flex;gap:4px;margin-bottom:6px;flex-wrap:wrap;}
.tag{font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:.12em;padding:2px 5px;border-radius:1px;}
.tag-active{background:rgba(0,229,255,.1);color:var(--accent);border:1px solid rgba(0,229,255,.25);}
.tag-new{background:rgba(0,255,136,.1);color:var(--ok);border:1px solid rgba(0,255,136,.25);animation:pulse 2s ease-in-out infinite;}
.tag-locked{background:rgba(42,58,74,.15);color:var(--muted);border:1px solid var(--border);}
.tag-critical{background:rgba(255,45,85,.1);color:var(--danger);border:1px solid rgba(255,45,85,.25);animation:pulse 1.5s ease-in-out infinite;}
.tag-done{background:rgba(0,255,136,.08);color:var(--ok);border:1px solid rgba(0,255,136,.2);}
.case-id{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:.08em;margin-bottom:3px;}
.case-title{font-size:12px;font-weight:700;color:var(--text);line-height:1.4;margin-bottom:4px;}
.case-footer{display:flex;align-items:center;justify-content:space-between;margin-top:6px;}
.case-meta{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--muted);}
.case-arrow{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--accent);transition:transform .2s;}
.case-card:hover .case-arrow{transform:translateX(3px);}

/* NOT-CONNECTED grid */
.not-conn-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;}

/* ─── LOG ─── */
.log-body{
  font-family:'Share Tech Mono',monospace;font-size:9px;line-height:2;
  height:160px;overflow-y:auto;display:flex;flex-direction:column-reverse;
  padding:12px 16px;
}
.log-line{display:flex;gap:10px;animation:fadeIn .35s ease;}
.log-time{color:var(--muted);width:54px;flex-shrink:0;}
.log-lv{width:44px;flex-shrink:0;}
.log-lv.ok{color:var(--ok);}
.log-lv.warn{color:var(--warn);}
.log-lv.err{color:var(--danger);}
.log-lv.info{color:var(--accent);}
.log-msg{color:var(--text-dim);}
.log-msg em{color:var(--text);font-style:normal;}

/* ─── SIGNAL ─── */
.signal-list{display:flex;flex-direction:column;gap:10px;padding:12px 16px;}
.signal-item{display:flex;flex-direction:column;gap:4px;}
.signal-lbl{display:flex;justify-content:space-between;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.1em;color:var(--text-dim);}
.signal-val{font-family:'Orbitron',monospace;font-size:9px;}
.signal-bar{height:2px;background:var(--border);border-radius:1px;overflow:hidden;}
.signal-fill{height:100%;border-radius:1px;background:var(--accent);box-shadow:0 0 4px var(--accent);transition:width 1.5s cubic-bezier(.4,0,.2,1);}
.signal-fill.warn{background:var(--warn);box-shadow:0 0 4px var(--warn);}
.signal-fill.danger{background:var(--danger);box-shadow:0 0 4px var(--danger);}
.signal-fill.ok{background:var(--ok);box-shadow:0 0 4px var(--ok);}

/* ─── REPORT ALERT ─── */
.report-alert{
  background:linear-gradient(135deg,rgba(255,45,85,.06),rgba(255,45,85,.02));
  border:1px solid rgba(255,45,85,.2);
  padding:14px 18px;display:flex;align-items:center;gap:16px;
  position:relative;overflow:hidden;
}
.report-alert::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--danger);box-shadow:0 0 10px var(--danger);}
.report-alert-text{flex:1;}
.report-alert-title{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;color:var(--danger);letter-spacing:.18em;margin-bottom:3px;}
.report-alert-desc{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:.05em;}
.btn-danger{
  background:rgba(255,45,85,.12);border:1px solid rgba(255,45,85,.35);
  color:var(--danger);font-family:'Share Tech Mono',monospace;font-size:9px;
  letter-spacing:.12em;padding:8px 14px;display:flex;align-items:center;gap:5px;
  transition:all .2s;white-space:nowrap;
}
.btn-danger:hover{background:rgba(255,45,85,.22);box-shadow:0 0 12px rgba(255,45,85,.2);}

/* ─── SERIAL ─── */
.serial-wrap{padding:16px;}
.serial-desc{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);line-height:1.9;margin-bottom:14px;letter-spacing:.04em;}
.serial-row{display:flex;gap:8px;}
.serial-input{
  flex:1;background:var(--bg);border:1px solid var(--border);
  color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:12px;
  letter-spacing:.18em;padding:9px 12px;outline:none;text-transform:uppercase;
  transition:border-color .2s,box-shadow .2s;
}
.serial-input::placeholder{color:var(--muted);}
.serial-input:focus{border-color:var(--accent);box-shadow:0 0 10px var(--glow);}
.btn-accent{
  background:rgba(0,229,255,.08);border:1px solid rgba(0,229,255,.25);
  color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:9px;
  letter-spacing:.14em;padding:9px 14px;transition:all .2s;white-space:nowrap;
}
.btn-accent:hover{background:rgba(0,229,255,.18);box-shadow:0 0 12px var(--glow);}
.serial-result{margin-top:8px;font-family:'Share Tech Mono',monospace;font-size:9px;height:16px;letter-spacing:.08em;}
.serial-result.ok{color:var(--ok);}
.serial-result.err{color:var(--danger);}

/* ─── PROFILE PAGE ─── */
.profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-group{display:flex;flex-direction:column;gap:6px;}
.form-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.18em;color:var(--text-dim);}
.form-input{
  background:var(--bg);border:1px solid var(--border);
  color:var(--text);font-family:'Share Tech Mono',monospace;font-size:11px;
  padding:9px 12px;outline:none;transition:border-color .2s,box-shadow .2s;
  letter-spacing:.06em;
}
.form-input:focus{border-color:var(--accent);box-shadow:0 0 10px var(--glow);}
.form-input[readonly]{color:var(--text-dim);cursor:default;}
.form-select{
  background:var(--bg);border:1px solid var(--border);
  color:var(--text);font-family:'Share Tech Mono',monospace;font-size:11px;
  padding:9px 12px;outline:none;appearance:none;
  transition:border-color .2s;cursor:pointer;
}
.form-select:focus{border-color:var(--accent);}
.btn-save{
  background:rgba(0,229,255,.1);border:1px solid rgba(0,229,255,.3);
  color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:9px;
  letter-spacing:.16em;padding:10px 20px;transition:all .2s;margin-top:4px;
}
.btn-save:hover{background:rgba(0,229,255,.2);box-shadow:0 0 14px var(--glow);}
.profile-stats{display:flex;flex-direction:column;gap:8px;}
.profile-stat{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.profile-stat:last-child{border-bottom:none;}
.profile-stat-lbl{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:.08em;}
.profile-stat-val{font-family:'Orbitron',monospace;font-size:11px;color:var(--text);font-weight:700;}
.save-msg{font-family:'Share Tech Mono',monospace;font-size:9px;height:16px;letter-spacing:.08em;}
.save-msg.ok{color:var(--ok);}
.save-msg.err{color:var(--danger);}

/* ─── SETTINGS ─── */
.settings-section{margin-bottom:20px;}
.settings-section-title{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.2em;color:var(--text-dim);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);gap:16px;}
.settings-row:last-child{border-bottom:none;}
.settings-row-text{flex:1;}
.settings-row-lbl{font-size:12px;font-weight:400;color:var(--text);margin-bottom:2px;}
.settings-row-desc{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:.04em;}
.toggle{position:relative;width:36px;height:20px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{
  position:absolute;inset:0;background:var(--border);border-radius:10px;
  cursor:pointer;transition:background .2s;
}
.toggle-slider::before{
  content:'';position:absolute;left:3px;top:3px;
  width:14px;height:14px;border-radius:50%;background:#fff;
  transition:transform .2s;
}
.toggle input:checked~.toggle-slider{background:var(--accent);box-shadow:0 0 8px var(--glow);}
.toggle input:checked~.toggle-slider::before{transform:translateX(16px);}
.mode-btns{display:flex;gap:6px;}
.mode-btn{
  background:var(--surface);border:1px solid var(--border);
  color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:9px;
  letter-spacing:.1em;padding:6px 10px;cursor:pointer;transition:all .2s;
}
.mode-btn.selected{background:rgba(0,229,255,.1);border-color:rgba(0,229,255,.3);color:var(--accent);}
.danger-zone{margin-top:8px;}
.btn-reset{
  background:rgba(255,45,85,.08);border:1px solid rgba(255,45,85,.25);
  color:var(--danger);font-family:'Share Tech Mono',monospace;font-size:9px;
  letter-spacing:.12em;padding:8px 14px;transition:all .2s;
}
.btn-reset:hover{background:rgba(255,45,85,.18);}

/* ─── REPORT PAGE ─── */
.report-wrap{padding:16px;}
.report-desc{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);line-height:2;margin-bottom:16px;letter-spacing:.04em;}
.report-case-select{margin-bottom:14px;}
.report-textarea{
  width:100%;background:var(--bg);border:1px solid var(--border);
  color:var(--text);font-family:'Share Tech Mono',monospace;font-size:11px;
  padding:12px;outline:none;resize:vertical;min-height:80px;
  transition:border-color .2s;letter-spacing:.05em;line-height:1.8;
}
.report-textarea:focus{border-color:var(--accent);box-shadow:0 0 10px var(--glow);}
.report-submit-row{display:flex;align-items:center;gap:12px;margin-top:12px;}
.report-result{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.08em;flex:1;}
.report-result.ok{color:var(--ok);}
.report-result.err{color:var(--danger);}

/* ─── TRANSMISSIONS ─── */
.transmission-list{display:flex;flex-direction:column;gap:8px;}
.transmission-item{
  background:var(--surface2);border:1px solid var(--border);
  padding:12px 14px;display:flex;gap:12px;align-items:flex-start;
  transition:border-color .2s;cursor:pointer;
}
.transmission-item:hover{border-color:var(--accent);}
.transmission-item.unread{border-left:2px solid var(--accent);}
.transmission-item.unread .trans-title{color:var(--accent);}
.trans-icon{font-family:'Share Tech Mono',monospace;font-size:16px;color:var(--border2);flex-shrink:0;width:24px;text-align:center;}
.trans-body{flex:1;}
.trans-title{font-size:12px;font-weight:700;color:var(--text);margin-bottom:3px;}
.trans-preview{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:.04em;line-height:1.6;}
.trans-meta{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--muted);margin-top:4px;}
.trans-badge{
  font-family:'Share Tech Mono',monospace;font-size:7px;
  background:var(--accent);color:var(--bg);
  padding:1px 5px;border-radius:1px;flex-shrink:0;margin-top:2px;
}

/* ─── MODAL ─── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
.modal{background:var(--surface);border:1px solid var(--border2);width:100%;max-width:480px;position:relative;max-height:80vh;overflow-y:auto;}
.modal-hdr{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,.3);}
.modal-title{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:.2em;color:var(--accent);}
.modal-close{background:none;border:none;color:var(--text-dim);font-size:18px;cursor:pointer;line-height:1;transition:color .15s;}
.modal-close:hover{color:var(--danger);}
.modal-body{padding:18px;}
.modal-desc{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);line-height:1.9;margin-bottom:14px;}
.modal-actions{display:flex;gap:8px;margin-top:14px;}

/* ─── LOGIN ─── */
#login-screen{
  position:fixed;inset:0;background:var(--bg);z-index:800;
  display:flex;align-items:center;justify-content:center;padding:20px;
}
.login-box{
  width:100%;max-width:360px;
  background:var(--surface);border:1px solid var(--border2);
  overflow:hidden;
}
.login-hdr{
  padding:24px 28px 18px;border-bottom:1px solid var(--border);
  background:rgba(0,0,0,.3);text-align:center;
}
.login-logo{font-family:'Orbitron',monospace;font-size:16px;font-weight:900;color:var(--accent);text-shadow:0 0 12px var(--accent);letter-spacing:.3em;margin-bottom:4px;}
.login-sub{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:.12em;}
.login-body{padding:24px 28px;}
.login-tabs{display:flex;gap:0;margin-bottom:20px;border:1px solid var(--border);}
.login-tab{
  flex:1;background:none;border:none;color:var(--text-dim);
  font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.1em;
  padding:8px;transition:all .2s;
}
.login-tab.active{background:rgba(0,229,255,.08);color:var(--accent);}
.login-err{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--danger);min-height:16px;margin-top:8px;letter-spacing:.06em;}
.login-info{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-top:14px;line-height:1.8;letter-spacing:.04em;}
.login-divider{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--muted);text-align:center;margin:14px 0;letter-spacing:.15em;}
.btn-twitter{
  width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);
  color:var(--text);font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.1em;
  padding:10px;display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .2s;cursor:pointer;
}
.btn-twitter:hover{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.25);}

/* ─── NOTIFICATION ─── */
.notif{
  position:fixed;top:60px;right:16px;z-index:1000;
  background:var(--surface);border:1px solid var(--border2);
  padding:10px 16px;
  font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.08em;
  animation:fadeIn .25s ease;min-width:220px;
}
.notif.ok{border-left:3px solid var(--ok);color:var(--ok);}
.notif.err{border-left:3px solid var(--danger);color:var(--danger);}
.notif.info{border-left:3px solid var(--accent);color:var(--accent);}

/* ─── RESPONSIVE ─── */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);}
  .sidebar.open{transform:translateX(0);}
  .main-area{margin-left:0;}
  .hamburger{display:block;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .not-conn-grid{grid-template-columns:repeat(2,1fr);}
  .profile-grid{grid-template-columns:1fr;}
  .bottom-row{grid-template-columns:1fr;}
}
@media(max-width:480px){
  .page{padding:14px;}
  .stats-grid{grid-template-columns:1fr 1fr;}
}
.bottom-row{display:grid;grid-template-columns:1fr 260px;gap:10px;}
@media(max-width:900px){.bottom-row{grid-template-columns:1fr;}}
</style>

<!-- ═══ FIREBASE SDK ═══ -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey:            "AIzaSyDyKbSlrn6klhCxugkQcKpkfnDLL86Ce4A",
  authDomain:        "echo-liminal.firebaseapp.com",
  projectId:         "echo-liminal",
  storageBucket:     "echo-liminal.firebasestorage.app",
  messagingSenderId: "953303593658",
  appId:             "1:953303593658:web:61c5db0cb03f0b0704c883"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

// Twitter プロバイダ
const twitterProvider = new firebase.auth.TwitterAuthProvider();
</script>
<!-- ═══ /FIREBASE SDK ═══ -->
</head>
<body>

<!-- BOOT -->
<div id="boot">
  <div class="boot-logo">LIMINAL SYS</div>
  <div class="boot-sub">// 閾値システム v2.1.7</div>
  <div class="boot-bar-wrap"><div class="boot-bar"></div></div>
  <div class="boot-msg" id="boot-msg">INITIALIZING...</div>
</div>

<!-- LOGIN -->
<div id="login-screen" style="display:none;">
  <div class="login-box">
    <div class="login-hdr">
      <div class="login-logo">LIMINAL</div>
      <div class="login-sub">// エージェント認証システム // Firebase Auth</div>
    </div>
    <div class="login-body">
      <div class="login-tabs">
        <button class="login-tab active" onclick="switchTab('login')">LOGIN</button>
        <button class="login-tab" onclick="switchTab('register')">REGISTER</button>
      </div>
      <!-- LOGIN FORM -->
      <div id="tab-login">
        <div class="form-group"><div class="form-label">EMAIL</div><input class="form-input" id="li-email" type="email" placeholder="agent@example.com"></div>
        <div class="form-group" style="margin-top:10px;"><div class="form-label">PASSWORD</div><input class="form-input" id="li-pass" type="password" placeholder="••••••••"></div>
        <div class="login-err" id="li-err"></div>
        <button class="btn-accent" style="width:100%;margin-top:12px;padding:11px;" onclick="doLogin()">AUTHENTICATE →</button>
        <div class="login-divider">── OR ──</div>
        <button class="btn-twitter" onclick="doTwitterLogin()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.742l7.73-8.835L1.254 2.25H8.08l4.259 5.63zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
          Continue with X (Twitter)
        </button>
        <div class="login-info">※ ECHO PROTOCOLのアカウントでもログインできます</div>
      </div>
      <!-- REGISTER FORM -->
      <div id="tab-register" style="display:none;">
        <div class="form-group"><div class="form-label">AGENT NAME (コードネーム)</div><input class="form-input" id="rg-name" type="text" placeholder="PHANTOM-XXX"></div>
        <div class="form-group" style="margin-top:10px;"><div class="form-label">EMAIL</div><input class="form-input" id="rg-email" type="email" placeholder="agent@example.com"></div>
        <div class="form-group" style="margin-top:10px;"><div class="form-label">PASSWORD (8文字以上)</div><input class="form-input" id="rg-pass" type="password" placeholder="••••••••"></div>
        <div class="login-err" id="rg-err"></div>
        <button class="btn-accent" style="width:100%;margin-top:12px;padding:11px;" onclick="doRegister()">REGISTER AGENT →</button>
        <div class="login-divider">── OR ──</div>
        <button class="btn-twitter" onclick="doTwitterLogin()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.742l7.73-8.835L1.254 2.25H8.08l4.259 5.63zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
          Continue with X (Twitter)
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN SHELL -->
<div class="shell" id="main-shell" style="display:none;">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-name">LIMINAL</div>
      <div class="sidebar-logo-sub">// 閾値システム v2.1.7</div>
    </div>
    <div class="agent-card">
      <div class="agent-label">AGENT ID</div>
      <div class="agent-name" id="sb-agent-name">---</div>
      <div class="agent-status"><div class="sdot"></div><div class="stext">CONNECTED</div></div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">PRIMARY</div>
      <button class="nav-item active" onclick="nav('dashboard')">
        <svg viewBox="0 0 16 16"><rect x="1" y="1" width="6" height="6"/><rect x="9" y="1" width="6" height="6"/><rect x="1" y="9" width="6" height="6"/><rect x="9" y="9" width="6" height="6"/></svg>
        HOME
      </button>
      <button class="nav-item" onclick="nav('cases')">
        <svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="6"/><circle cx="8" cy="8" r="2"/><line x1="8" y1="2" x2="8" y2="4"/><line x1="8" y1="12" x2="8" y2="14"/><line x1="2" y1="8" x2="4" y2="8"/><line x1="12" y1="8" x2="14" y2="8"/></svg>
        CASE
        <span class="nav-badge" id="new-badge" style="display:none">NEW</span>
      </button>
      <button class="nav-item" onclick="nav('transmissions')">
        <svg viewBox="0 0 16 16"><path d="M1 3h14v10H1z"/><path d="M1 3l7 6 7-6"/></svg>
        D4-MAIL
        <span class="nav-badge" id="mail-badge">2</span>
      </button>
      <button class="nav-item disabled">
        <svg viewBox="0 0 16 16"><path d="M2 12l3-3h9V3H2v9z"/></svg>
        D4-MESSAGE
      </button>
      <button class="nav-item disabled">
        <svg viewBox="0 0 16 16"><path d="M8 2C4.7 2 2 4.3 2 7c0 1.7.9 3.2 2.2 4.1L3 14l2.8-1.5C6.5 12.8 7.2 13 8 13c3.3 0 6-2.3 6-5s-2.7-5-6-5z"/></svg>
        D4-BIRD
      </button>
      <div class="nav-section" style="margin-top:6px;">SYSTEM</div>
      <button class="nav-item" onclick="nav('profile')">
        <svg viewBox="0 0 16 16"><circle cx="8" cy="5" r="3"/><path d="M2 14c0-3.3 2.7-6 6-6s6 2.7 6 6"/></svg>
        PROFILE
      </button>
      <button class="nav-item" onclick="nav('serial')">
        <svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" rx="1"/><line x1="5" y1="2" x2="5" y2="14"/><line x1="11" y1="2" x2="11" y2="14"/></svg>
        SERIAL CODE
      </button>
      <button class="nav-item" onclick="nav('report')">
        <svg viewBox="0 0 16 16"><path d="M8 1l1.5 5h5l-4 3 1.5 5L8 11l-4 3 1.5-5-4-3h5z"/></svg>
        REPORT
      </button>
      <button class="nav-item" onclick="nav('settings')">
        <svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="2"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.2 3.2l1.4 1.4M11.4 11.4l1.4 1.4M3.2 12.8l1.4-1.4M11.4 4.6l1.4-1.4"/></svg>
        SETTINGS
      </button>
    </nav>
    <div class="sidebar-foot">
      <div class="ver">BUILD 20260217.ALPHA</div>
      <div class="copyright">©LIMINAL / D4KK</div>
    </div>
  </aside>

  <div class="main-area">
    <!-- TOPBAR -->
    <header class="topbar">
      <button class="hamburger" onclick="toggleSidebar()"><svg viewBox="0 0 20 20"><line x1="2" y1="5" x2="18" y2="5"/><line x1="2" y1="10" x2="18" y2="10"/><line x1="2" y1="15" x2="18" y2="15"/></svg></button>
      <div class="breadcrumb">SYS:// <span id="page-label">DASHBOARD</span></div>
      <div class="topbar-clock" id="clock">--:--:--</div>
      <button class="topbar-btn" onclick="nav('report')">⚑ LAST WORD</button>
    </header>

    <!-- ── DASHBOARD ── -->
    <div class="page active" id="page-dashboard">
      <!-- REPORT ALERT -->
      <div class="report-alert" id="report-alert" style="display:none;">
        <div class="report-alert-text">
          <div class="report-alert-title">⚠ MISSION COMPLETION DETECTED</div>
          <div class="report-alert-desc" id="report-alert-desc">調査完了ミッションが検出されました。ラストワードを送信してください。</div>
        </div>
        <button class="btn-danger" onclick="nav('report')">SUBMIT →</button>
      </div>

      <!-- STATS -->
      <div>
        <div class="sec-hdr"><div class="sec-title">STATUS OVERVIEW</div><div class="sec-line"></div></div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-lbl">CONNECTED CASES</div><div class="stat-val c-accent" id="st-connected">0</div><div class="stat-sub">購入・接続済み</div></div>
          <div class="stat-card"><div class="stat-lbl">COMPLETED</div><div class="stat-val c-ok" id="st-done">0</div><div class="stat-sub">REPORT送信済み</div></div>
          <div class="stat-card"><div class="stat-lbl">NOT CONNECTED</div><div class="stat-val" id="st-locked">0</div><div class="stat-sub">未接続ケース</div></div>
          <div class="stat-card"><div class="stat-lbl">GAME MODE</div><div class="stat-val c-warn" id="st-mode" style="font-size:14px;margin-top:4px;">STANDARD</div><div class="stat-sub">現在のモード</div></div>
        </div>
      </div>

      <!-- CONNECTED -->
      <div id="connected-section">
        <div class="sec-hdr">
          <div class="sec-title">CONNECTED</div>
          <div class="sec-line"></div>
          <div class="sec-count" id="conn-count">0 CASES</div>
        </div>
        <div id="connected-empty" style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);padding:20px 0;letter-spacing:.08em;display:none;">
          接続済みケースはありません。シリアルコードを入力して解錠してください。
        </div>
        <div style="position:relative;">
          <div class="carousel-wrap" id="carousel-wrap">
            <div class="carousel-track" id="carousel-track"></div>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;" id="carousel-controls">
            <div class="carousel-nav" id="carousel-dots"></div>
            <div class="carousel-arrows">
              <button class="carr-btn" onclick="carouselPrev()">←</button>
              <button class="carr-btn" onclick="carouselNext()">→</button>
            </div>
          </div>
        </div>
      </div>

      <!-- NOT CONNECTED -->
      <div>
        <div class="sec-hdr">
          <div class="sec-title">NOT CONNECTED</div>
          <div class="sec-line"></div>
          <div class="sec-count" id="not-conn-count">0 CASES</div>
        </div>
        <div class="not-conn-grid" id="not-conn-grid"></div>
      </div>

      <!-- BOTTOM -->
      <div class="bottom-row">
        <div class="panel">
          <div class="panel-hdr">
            <div class="panel-title">TRANSMISSION LOG</div>
            <div class="panel-sub"><div class="live-dot"></div> LIVE</div>
          </div>
          <div class="log-body" id="log-body"></div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><div class="panel-title">SIGNAL ANALYSIS</div><div class="panel-sub">REAL-TIME</div></div>
          <div class="signal-list" id="signal-list">
            <div class="signal-item"><div class="signal-lbl"><span>NEURAL BRIDGE</span><span class="signal-val" style="color:var(--accent)">94%</span></div><div class="signal-bar"><div class="signal-fill" data-w="94"></div></div></div>
            <div class="signal-item"><div class="signal-lbl"><span>REALITY ANCHOR</span><span class="signal-val" style="color:var(--warn)">74%</span></div><div class="signal-bar"><div class="signal-fill warn" data-w="74"></div></div></div>
            <div class="signal-item"><div class="signal-lbl"><span>VOID INTERFERENCE</span><span class="signal-val" style="color:var(--danger)">41%</span></div><div class="signal-bar"><div class="signal-fill danger" data-w="41"></div></div></div>
            <div class="signal-item"><div class="signal-lbl"><span>AGENT SYNC</span><span class="signal-val" style="color:var(--ok)">100%</span></div><div class="signal-bar"><div class="signal-fill ok" data-w="100"></div></div></div>
            <div class="signal-item"><div class="signal-lbl"><span>LIMINAL GATE</span><span class="signal-val" style="color:var(--accent)">88%</span></div><div class="signal-bar"><div class="signal-fill" data-w="88"></div></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ── CASE LIST ── -->
    <div class="page" id="page-cases">
      <div class="sec-hdr"><div class="sec-title">ALL CASES</div><div class="sec-line"></div><div class="sec-count" id="all-case-count">0 CASES</div></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;" id="case-filter-btns">
        <button class="mode-btn selected" onclick="filterCases('all',this)">ALL</button>
        <button class="mode-btn" onclick="filterCases('connected',this)">CONNECTED</button>
        <button class="mode-btn" onclick="filterCases('not_connected',this)">NOT CONNECTED</button>
        <button class="mode-btn" onclick="filterCases('completed',this)">COMPLETED</button>
      </div>
      <div class="not-conn-grid" id="all-cases-grid" style="grid-template-columns:repeat(auto-fill,minmax(180px,1fr));"></div>
    </div>

    <!-- ── D4-MAIL ── -->
    <div class="page" id="page-transmissions">
      <div class="sec-hdr"><div class="sec-title">D4-MAIL // 交錯通信</div><div class="sec-line"></div></div>
      <div class="transmission-list" id="trans-list"></div>
    </div>

    <!-- ── PROFILE ── -->
    <div class="page" id="page-profile">
      <div class="sec-hdr"><div class="sec-title">PROFILE // エージェント情報</div><div class="sec-line"></div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;" class="profile-grid-outer">
        <div class="panel">
          <div class="panel-hdr"><div class="panel-title">AGENT DATA</div></div>
          <div class="panel-body" style="display:flex;flex-direction:column;gap:10px;">
            <div class="form-group"><div class="form-label">AGENT NAME (コードネーム)</div><input class="form-input" id="pr-name" type="text"></div>
            <div class="form-group"><div class="form-label">EMAIL ADDRESS</div><input class="form-input" id="pr-email" type="email"></div>
            <div class="form-group"><div class="form-label">REGISTRATION DATE</div><input class="form-input" id="pr-date" type="text" readonly></div>
            <div class="save-msg" id="pr-save-msg"></div>
            <button class="btn-save" onclick="saveProfile()">SAVE CHANGES →</button>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><div class="panel-title">PROGRESS STATS</div></div>
          <div class="panel-body">
            <div class="profile-stats" id="profile-stats"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ── SERIAL CODE ── -->
    <div class="page" id="page-serial">
      <div class="sec-hdr"><div class="sec-title">SERIAL CODE // 解錠インターフェース</div><div class="sec-line"></div></div>
      <div class="panel">
        <div class="panel-hdr"><div class="panel-title">CODE ENTRY</div><div class="panel-sub">UNLOCK NEW CASES</div></div>
        <div class="serial-wrap">
          <div class="serial-desc">
            新たな扉を解錠するためのシリアルコードを入力してください。<br>
            コードは公式物販または同梱物より取得可能です。<br>
            すでに登録済みのコードは再利用できません。
          </div>
          <div class="serial-row">
            <input class="serial-input" id="serial-input" type="text" placeholder="XXXX-XXXX-XXXX" maxlength="14" spellcheck="false">
            <button class="btn-accent" onclick="validateSerial()">EXECUTE →</button>
          </div>
          <div class="serial-result" id="serial-result"></div>
        </div>
      </div>
      <div class="panel" style="margin-top:0;">
        <div class="panel-hdr"><div class="panel-title">UNLOCK HISTORY</div></div>
        <div class="panel-body">
          <div id="unlock-history" style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);line-height:2.2;letter-spacing:.06em;"></div>
        </div>
      </div>
    </div>

    <!-- ── REPORT ── -->
    <div class="page" id="page-report">
      <div class="sec-hdr"><div class="sec-title">REPORT // ラストワード送信</div><div class="sec-line"></div></div>
      <div class="panel">
        <div class="panel-hdr"><div class="panel-title">MISSION REPORT</div><div class="panel-sub" style="color:var(--danger);">⚑ REQUIRED</div></div>
        <div class="report-wrap">
          <div class="report-desc">
            物語の調査を完了されたエージェントは、<br>
            対象ケースを選択し、ラストワードを入力して送信してください。<br>
            ラストワードは物語の解決後に判明する最終キーワードです。
          </div>
          <div class="form-group report-case-select">
            <div class="form-label">TARGET CASE</div>
            <select class="form-select" id="report-case-select"></select>
          </div>
          <div class="form-group">
            <div class="form-label">LAST WORD</div>
            <textarea class="report-textarea" id="report-lastword" placeholder="ラストワードを入力..."></textarea>
          </div>
          <div class="report-submit-row">
            <button class="btn-danger" style="padding:10px 18px;" onclick="submitReport()">⚑ SUBMIT REPORT</button>
            <div class="report-result" id="report-result"></div>
          </div>
          <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px;">
            <div class="form-label" style="margin-bottom:8px;">REPORT HISTORY</div>
            <div id="report-history" style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);line-height:2.2;letter-spacing:.06em;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ── SETTINGS ── -->
    <div class="page" id="page-settings">
      <div class="sec-hdr"><div class="sec-title">SETTINGS // システム設定</div><div class="sec-line"></div></div>
      <div class="panel">
        <div class="panel-hdr"><div class="panel-title">ACCOUNT</div></div>
        <div class="panel-body">
          <div class="settings-section">
            <div class="settings-section-title">アカウント情報</div>
            <div class="settings-row">
              <div class="settings-row-text"><div class="settings-row-lbl">メールアドレス変更</div><div class="settings-row-desc">ログインに使用するメールアドレスを変更します</div></div>
              <button class="btn-accent" onclick="showModal('change-email')">CHANGE →</button>
            </div>
            <div class="settings-row">
              <div class="settings-row-text"><div class="settings-row-lbl">パスワード変更</div><div class="settings-row-desc">アクセスキーを更新します</div></div>
              <button class="btn-accent" onclick="showModal('change-pass')">CHANGE →</button>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">ゲームモード</div>
            <div class="settings-row">
              <div class="settings-row-text"><div class="settings-row-lbl">PLAY MODE</div><div class="settings-row-desc">ゲーム進行モードを選択します</div></div>
              <div class="mode-btns">
                <button class="mode-btn" id="mode-solo" onclick="setMode('SOLO')">SOLO</button>
                <button class="mode-btn selected" id="mode-standard" onclick="setMode('STANDARD')">STANDARD</button>
                <button class="mode-btn" id="mode-hard" onclick="setMode('HARD')">HARD</button>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">通知設定</div>
            <div class="settings-row">
              <div class="settings-row-text"><div class="settings-row-lbl">新着ミッション通知</div><div class="settings-row-desc">新しいケース解放時に通知します</div></div>
              <label class="toggle"><input type="checkbox" id="notif-missions" checked><span class="toggle-slider"></span></label>
            </div>
            <div class="settings-row">
              <div class="settings-row-text"><div class="settings-row-lbl">D4-MAIL受信通知</div><div class="settings-row-desc">交錯通信受信時に通知します</div></div>
              <label class="toggle"><input type="checkbox" id="notif-mail" checked><span class="toggle-slider"></span></label>
            </div>
            <div class="settings-row">
              <div class="settings-row-text"><div class="settings-row-lbl">スキャンライン</div><div class="settings-row-desc">画面のスキャンラインエフェクト</div></div>
              <label class="toggle"><input type="checkbox" id="notif-scan" checked onchange="toggleScanlines(this)"><span class="toggle-slider"></span></label>
            </div>
          </div>
          <div class="settings-section danger-zone">
            <div class="settings-section-title" style="color:var(--danger);">DANGER ZONE</div>
            <div class="settings-row">
              <div class="settings-row-text"><div class="settings-row-lbl">ログアウト</div><div class="settings-row-desc">エージェント認証を解除します</div></div>
              <button class="btn-reset" onclick="doLogout()">LOGOUT →</button>
            </div>
            <div class="settings-row">
              <div class="settings-row-text"><div class="settings-row-lbl">全データリセット</div><div class="settings-row-desc" style="color:var(--danger);">解錠済みケース・進行状況がすべて消去されます</div></div>
              <button class="btn-reset" onclick="showModal('reset-data')">RESET →</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /main-area -->
</div><!-- /shell -->

<!-- MODALS -->
<div id="modal-overlay" style="display:none;" class="modal-overlay" onclick="closeModalOutside(event)">
  <!-- change-email -->
  <div class="modal" id="modal-change-email" style="display:none;">
    <div class="modal-hdr"><div class="modal-title">CHANGE EMAIL</div><button class="modal-close" onclick="closeModal()">×</button></div>
    <div class="modal-body">
      <div class="form-group"><div class="form-label">NEW EMAIL ADDRESS</div><input class="form-input" id="m-email" type="email" style="width:100%"></div>
      <div class="form-group" style="margin-top:10px;"><div class="form-label">CURRENT PASSWORD (確認)</div><input class="form-input" id="m-email-pass" type="password" style="width:100%"></div>
      <div class="modal-actions">
        <button class="btn-accent" onclick="changeEmail()">SAVE →</button>
        <button class="btn-reset" onclick="closeModal()">CANCEL</button>
      </div>
    </div>
  </div>
  <!-- change-pass -->
  <div class="modal" id="modal-change-pass" style="display:none;">
    <div class="modal-hdr"><div class="modal-title">CHANGE PASSWORD</div><button class="modal-close" onclick="closeModal()">×</button></div>
    <div class="modal-body">
      <div class="form-group"><div class="form-label">CURRENT PASSWORD</div><input class="form-input" id="m-old-pass" type="password" style="width:100%"></div>
      <div class="form-group" style="margin-top:10px;"><div class="form-label">NEW PASSWORD (8文字以上)</div><input class="form-input" id="m-new-pass" type="password" style="width:100%"></div>
      <div class="modal-actions">
        <button class="btn-accent" onclick="changePassword()">SAVE →</button>
        <button class="btn-reset" onclick="closeModal()">CANCEL</button>
      </div>
    </div>
  </div>
  <!-- reset-data -->
  <div class="modal" id="modal-reset-data" style="display:none;">
    <div class="modal-hdr"><div class="modal-title" style="color:var(--danger);">⚠ DATA RESET</div><button class="modal-close" onclick="closeModal()">×</button></div>
    <div class="modal-body">
      <div class="modal-desc" style="color:var(--danger);">すべての進行データ（接続済みケース・解錠履歴・レポート）が完全に消去されます。この操作は取り消せません。</div>
      <div class="modal-actions">
        <button class="btn-reset" onclick="resetAllData()">CONFIRM RESET →</button>
        <button class="btn-accent" onclick="closeModal()">CANCEL</button>
      </div>
    </div>
  </div>
  <!-- case-detail -->
  <div class="modal" id="modal-case-detail" style="display:none;max-width:520px;">
    <div class="modal-hdr"><div class="modal-title" id="modal-case-id">CASE</div><button class="modal-close" onclick="closeModal()">×</button></div>
    <div class="modal-body" id="modal-case-body"></div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ═══════════════════════════════════════════════════
//  DATA
// ═══════════════════════════════════════════════════
const CASES = [
  { id:'case-001', title:'桶地下', desc:'地下空間より断続的に受信される信号の発信源を特定せよ。暗闇の奥に何かが潜んでいる。', tag:'NEW',      purchaseUrl:'#', gameUrl:'#', thumb:'#0d1520', icon:'001' },
  { id:'case-002', title:'ノンレゾン 1st写真集〈QUINTET〉', desc:'消えた写真家が残した最後のフィルム現像データを解読し、失われた真実を暴け。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#150d0d', icon:'002' },
  { id:'case-003', title:'SILENT DESCENT', desc:'地下第4層で記録された異常振動のパターンを分析し、次の発生座標を予測せよ。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#0f0d18', icon:'003' },
  { id:'case-004', title:'少年の声、彼女のうた', desc:'二つの時間軸で交差する記憶の断片を繋ぎ合わせ、消えた少年を追え。', tag:'NEW',      purchaseUrl:'#', gameUrl:'#', thumb:'#0d1520', icon:'004' },
  { id:'case-005', title:'人のカレンダー', desc:'他人の手帳に記された31の暗号を解読し、隠された約束の場所を突き止めろ。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#100d15', icon:'005' },
  { id:'case-006', title:'幽怪食堂', desc:'深夜にだけ現れる食堂の全メニューに隠されたメッセージを解析せよ。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#0d1218', icon:'006' },
  { id:'case-007', title:'残置物Archive', desc:'廃墟に残された遺留品群から持ち主の素性と失踪の真相を復元せよ。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#120d0d', icon:'007' },
  { id:'case-008', title:'事故物件鑑定士試験', desc:'6つの事故物件のデータを分析し、次の発生を未然に防ぐ法則を導け。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#0d1520', icon:'008' },
  { id:'case-009', title:'RtS One Last Free Throw', desc:'最後のシュートに隠されたコードを解読し、失われた栄光の夜を取り戻せ。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#0d1218', icon:'009' },
  { id:'case-010', title:'RtS Family ties', desc:'家族の絆を装った組織の真の目的を暴け。偽りの記録が鍵を握る。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#0f100d', icon:'010' },
  { id:'case-011', title:'人の交換日記', desc:'見知らぬ二人が交わした日記に埋め込まれた暗号の解読に挑め。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#100d0d', icon:'011' },
  { id:'case-012', title:'人の給与明細', desc:'一枚の給与明細から、隠蔽された組織の全体像を浮かび上がらせろ。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#0d1520', icon:'012' },
  { id:'case-013', title:'幽怪エレベーター', desc:'深夜の廃ビルで繰り返し停止する昇降機の乗客リストを復元せよ。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#0d0d18', icon:'013' },
  { id:'case-014', title:'かがみの特殊少年更生施設', desc:'施設の記録に散らばる失踪者の痕跡を辿り、その真実を明らかにせよ。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#100d0d', icon:'014' },
  { id:'case-015', title:'人の財布', desc:'路上で発見された財布の持ち主に隠された複数の素性を解明せよ。', tag:'ACTIVE',   purchaseUrl:'#', gameUrl:'#', thumb:'#0d1218', icon:'015' },
];

const TRANSMISSIONS = [
  { id:'tm-001', from:'SYSTEM', title:'LIMINAL SYS // ようこそ、エージェント', preview:'あなたのエージェント登録が完了しました。閾値システムへのアクセスが許可されています...', date:'2026.02.17 04:21', read:false },
  { id:'tm-002', from:'D4-CORE', title:'[ALERT] CASE-002 異常信号検出', preview:'桶地下方面より断続的な異常信号を検出。至急調査を開始してください。暗号化されたデータパケット...', date:'2026.02.16 23:55', read:false },
  { id:'tm-003', from:'AGENT-PHANTOM', title:'Re: 残置物について', preview:'例の遺留品の解析が完了しました。添付の復号化ファイルを参照してください...', date:'2026.02.15 18:30', read:true },
  { id:'tm-004', from:'SYSTEM', title:'シリアルコード: GATE-7F2A-001 発行', preview:'購入確認が完了しました。以下のシリアルコードをBPSに登録してください...', date:'2026.02.14 12:00', read:true },
];

// SERIAL CODE DATABASE
const SERIAL_DB = {
  'GATE-7F2A-001': { caseId:'case-001', label:'桶地下' },
  'OPEN-TEST-001': { caseId:'case-002', label:'ノンレゾン 1st写真集〈QUINTET〉' },
  'VOID-XXXX-001': { caseId:'case-003', label:'SILENT DESCENT' },
  'DARK-8B3E-001': { caseId:'case-004', label:'少年の声、彼女のうた' },
  'ARCV-CLDR-001': { caseId:'case-005', label:'人のカレンダー' },
};

// LAST WORD DATABASE (答え合わせ用デモ)
const LASTWORD_DB = {
  'case-001': ['OKECHIKA','オケチカ','桶地下'],
  'case-002': ['QUINTET','クインテット'],
};

// ═══════════════════════════════════════════════════
//  STATE — ユーザーデータはFirestore、UIのみlocalStorage
// ═══════════════════════════════════════════════════
let currentFbUser = null;  // Firebase User オブジェクト
let userDoc       = {};    // Firestoreから取得したユーザーデータ

// localStorageキー: ゲームデータ（接続・完了・履歴）はFirestoreに保存
// usedCodesはFirestore上のグローバルコレクションで管理

function uid() { return currentFbUser ? currentFbUser.uid : null; }

async function loadUserDoc() {
  if (!uid()) return;
  const snap = await db.collection('users').doc(uid()).get();
  if (snap.exists) {
    userDoc = snap.data();
  } else {
    // 初回: ドキュメント作成
    const now = new Date();
    const reg = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
    userDoc = {
      name:        currentFbUser.displayName || 'AGENT-' + uid().slice(0,5).toUpperCase(),
      email:       currentFbUser.email || '',
      reg,
      mode:        'STANDARD',
      connected:   [],
      completed:   [],
      unlockHist:  [],
      reportHist:  [],
      readMails:   {},
    };
    await db.collection('users').doc(uid()).set(userDoc);
  }
}

async function saveUserDoc(partial) {
  if (!uid()) return;
  Object.assign(userDoc, partial);
  await db.collection('users').doc(uid()).update(partial);
}

function getConnected()  { return userDoc.connected   || []; }
function getCompleted()  { return userDoc.completed   || []; }
function getUnlockHist() { return userDoc.unlockHist  || []; }
function getReportHist() { return userDoc.reportHist  || []; }

// ═══════════════════════════════════════════════════
//  BOOT SEQUENCE
// ═══════════════════════════════════════════════════
const BOOT_MSGS = [
  'INITIALIZING NEURAL BRIDGE...',
  'LOADING CASE DATABASE...',
  'CALIBRATING SIGNAL ARRAY...',
  'AUTHENTICATING AGENT...',
  'LIMINAL GATE OPEN.',
];

document.addEventListener('DOMContentLoaded', () => {
  let i = 0;
  const msgEl = document.getElementById('boot-msg');
  const iv = setInterval(() => {
    i++;
    if (i < BOOT_MSGS.length) { msgEl.textContent = BOOT_MSGS[i]; }
    else { clearInterval(iv); }
  }, 400);
  startClock();

  // Firebase Auth 状態監視 — ここがすべての起点
  auth.onAuthStateChanged(async (user) => {
    const boot = document.getElementById('boot');
    if (user) {
      currentFbUser = user;
      await loadUserDoc();
      boot.style.opacity = '0';
      setTimeout(() => { boot.style.display = 'none'; initApp(); }, 600);
    } else {
      currentFbUser = null;
      userDoc = {};
      boot.style.opacity = '0';
      setTimeout(() => { boot.style.display = 'none'; showLogin(); }, 600);
    }
  });
});

// ═══════════════════════════════════════════════════
//  AUTH
// ═══════════════════════════════════════════════════
function showLogin() {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('main-shell').style.display  = 'none';
}

function switchTab(tab) {
  document.getElementById('tab-login').style.display    = tab==='login'    ? 'block' : 'none';
  document.getElementById('tab-register').style.display = tab==='register' ? 'block' : 'none';
  document.querySelectorAll('.login-tab').forEach((b,i) => b.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register')));
}

function setLoginErr(id, msg) { document.getElementById(id).textContent = msg; }

// メール/パスワード ログイン
async function doLogin() {
  const email = document.getElementById('li-email').value.trim();
  const pass  = document.getElementById('li-pass').value;
  setLoginErr('li-err', '');
  if (!email || !pass) { setLoginErr('li-err','✗ メールとパスワードを入力してください'); return; }
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    // onAuthStateChanged が自動的にinitApp()を呼ぶ
  } catch(e) {
    setLoginErr('li-err', '✗ ' + fbErrMsg(e.code));
  }
}

// メール/パスワード 新規登録
async function doRegister() {
  const name  = document.getElementById('rg-name').value.trim();
  const email = document.getElementById('rg-email').value.trim();
  const pass  = document.getElementById('rg-pass').value;
  setLoginErr('rg-err','');
  if (!name)          { setLoginErr('rg-err','✗ AGENT NAME を入力してください'); return; }
  if (!email)         { setLoginErr('rg-err','✗ メールアドレスを入力してください'); return; }
  if (pass.length<8)  { setLoginErr('rg-err','✗ パスワードは8文字以上必要です'); return; }
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await cred.user.updateProfile({ displayName: name });
    currentFbUser = cred.user;
    // Firestoreにユーザードキュメントを作成
    await loadUserDoc();
    // nameを上書き保存
    await saveUserDoc({ name, email });
    // onAuthStateChanged が自動呼び出し
  } catch(e) {
    setLoginErr('rg-err','✗ ' + fbErrMsg(e.code));
  }
}

// Twitter (X) ログイン
async function doTwitterLogin() {
  try {
    await auth.signInWithPopup(twitterProvider);
    // onAuthStateChanged → loadUserDoc → initApp の流れで処理
  } catch(e) {
    notify('✗ Twitterログインに失敗しました: ' + fbErrMsg(e.code), 'err');
  }
}

// ログアウト
async function doLogout() {
  await auth.signOut();
  // onAuthStateChanged → showLogin() が自動で呼ばれる
}

// Firebaseエラーコードを日本語に
function fbErrMsg(code) {
  const map = {
    'auth/invalid-email':            'メールアドレスの形式が正しくありません',
    'auth/user-disabled':            'このアカウントは無効化されています',
    'auth/user-not-found':           'アカウントが見つかりません',
    'auth/wrong-password':           'パスワードが間違っています',
    'auth/invalid-credential':       'メールアドレスまたはパスワードが正しくありません',
    'auth/email-already-in-use':     'このメールアドレスは既に使用されています',
    'auth/weak-password':            'パスワードは8文字以上にしてください',
    'auth/popup-closed-by-user':     'ログインがキャンセルされました',
    'auth/cancelled-popup-request':  'ポップアップがキャンセルされました',
    'auth/popup-blocked':            'ポップアップがブロックされました。許可してください',
    'auth/account-exists-with-different-credential': '同じメールアドレスで別の方法で登録済みです',
  };
  return map[code] || code;
}

// ═══════════════════════════════════════════════════
//  APP INIT
// ═══════════════════════════════════════════════════
function initApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('main-shell').style.display   = 'flex';
  const name  = userDoc.name  || currentFbUser?.displayName || 'AGENT';
  const email = userDoc.email || currentFbUser?.email || '';
  document.getElementById('sb-agent-name').textContent = name;
  document.getElementById('pr-name').value  = name;
  document.getElementById('pr-email').value = email;
  document.getElementById('pr-date').value  = userDoc.reg || '---';
  document.getElementById('st-mode').textContent = userDoc.mode || 'STANDARD';
  renderDashboard();
  renderTransmissions();
  renderReportCaseSelect();
  renderAllCases();
  renderProfileStats();
  renderUnlockHistory();
  renderReportHistory();
  updateModeButtons();
  startLogFeed();
  setTimeout(() => {
    document.querySelectorAll('.signal-fill').forEach(el => { el.style.width = el.dataset.w + '%'; });
  }, 300);
  const unread = TRANSMISSIONS.filter(t => !(userDoc.readMails||{})[t.id]).length;
  const mailBadge = document.getElementById('mail-badge');
  if (unread > 0) { mailBadge.textContent = unread; mailBadge.style.display = ''; }
  else { mailBadge.style.display = 'none'; }
}

// ═══════════════════════════════════════════════════
//  DASHBOARD RENDER
// ═══════════════════════════════════════════════════
let carouselIdx = 0;
const CAROUSEL_VISIBLE = 3;

function renderDashboard() {
  const conn = getConnected();
  const comp = getCompleted().map(r => r.caseId);
  const connCases = CASES.filter(c => conn.includes(c.id));
  const notConn   = CASES.filter(c => !conn.includes(c.id));

  // stats
  document.getElementById('st-connected').textContent = conn.length;
  document.getElementById('st-done').textContent = comp.length;
  document.getElementById('st-locked').textContent = notConn.length;
  document.getElementById('conn-count').textContent = conn.length + ' CASES';
  document.getElementById('not-conn-count').textContent = notConn.length + ' CASES';

  // report alert
  const compSet = new Set(comp);
  const needReport = conn.filter(id => !compSet.has(id));
  const alertEl = document.getElementById('report-alert');
  if (needReport.length > 0 && conn.length > 0) {
    alertEl.style.display = 'flex';
    document.getElementById('report-alert-desc').textContent = `${needReport.length}件の接続済みケースのレポートが未送信です。`;
  } else { alertEl.style.display = 'none'; }

  // carousel
  const track = document.getElementById('carousel-track');
  const dotsEl = document.getElementById('carousel-dots');
  const ctrls = document.getElementById('carousel-controls');
  const emptyEl = document.getElementById('connected-empty');

  if (connCases.length === 0) {
    emptyEl.style.display = 'block';
    track.innerHTML = '';
    dotsEl.innerHTML = '';
    ctrls.style.display = 'none';
    carouselIdx = 0;
  } else {
    emptyEl.style.display = 'none';
    ctrls.style.display = 'flex';
    track.innerHTML = connCases.map(c => caseCardHTML(c, comp.includes(c.id), true)).join('');
    track.querySelectorAll('.case-card').forEach((el, i) => {
      el.style.width = `calc((100% - ${(Math.min(CAROUSEL_VISIBLE,connCases.length)-1)*10}px) / ${Math.min(CAROUSEL_VISIBLE,connCases.length)})`;
      el.addEventListener('click', () => openCaseDetail(connCases[i].id));
    });
    const pages = Math.ceil(connCases.length / CAROUSEL_VISIBLE);
    dotsEl.innerHTML = Array.from({length:pages},(_,i) => `<button class="carousel-dot ${i===0?'active':''}" onclick="goCarousel(${i})"></button>`).join('');
    carouselIdx = 0;
    updateCarousel(connCases.length);
  }

  // not connected
  const ncGrid = document.getElementById('not-conn-grid');
  ncGrid.innerHTML = notConn.map(c => caseCardHTML(c, false, false)).join('');
  ncGrid.querySelectorAll('.case-card:not(.locked)').forEach((el, i) => {
    el.addEventListener('click', () => openCaseDetail(notConn[i].id));
  });
}

function caseCardHTML(c, done, connected) {
  const prog = done ? 100 : connected ? Math.floor(Math.random()*60+20) : 0;
  const progClass = done ? 'ok' : prog > 60 ? '' : prog > 30 ? 'warn' : '';
  const tagLabel = done ? 'COMPLETE' : c.tag;
  const tagClass = done ? 'tag-done' : c.tag==='NEW' ? 'tag-new' : connected ? 'tag-active' : 'tag-locked';
  return `<div class="case-card ${!connected?'locked':''}">
    <div class="case-thumb" style="background:${c.thumb};">
      <div class="case-thumb-overlay"></div>
      <span>${c.icon}</span>
      <div class="case-progress"><div class="case-progress-fill ${progClass}" style="width:${prog}%"></div></div>
    </div>
    <div class="case-body">
      <div class="case-tags"><span class="tag ${tagClass}">${tagLabel}</span></div>
      <div class="case-id">${c.id.toUpperCase()}</div>
      <div class="case-title">${c.title}</div>
      <div class="case-footer">
        <div class="case-meta">${connected ? 'PROGRESS '+prog+'%' : '未接続'}</div>
        <div class="case-arrow">${connected?'→':'⊘'}</div>
      </div>
    </div>
  </div>`;
}

function updateCarousel(total) {
  const track = document.getElementById('carousel-track');
  const visible = Math.min(CAROUSEL_VISIBLE, total);
  const itemW = `calc((100% - ${(visible-1)*10}px) / ${visible})`;
  const slideW = (100/visible * carouselIdx);
  track.style.transform = `translateX(-${slideW}%)`;
  document.querySelectorAll('.carousel-dot').forEach((d,i) => d.classList.toggle('active', i===carouselIdx));
}

function goCarousel(i) { carouselIdx = i; updateCarousel(getConnected().length); }
function carouselNext() {
  const total = getConnected().length;
  const pages = Math.ceil(total/CAROUSEL_VISIBLE);
  if (carouselIdx < pages-1) { carouselIdx++; updateCarousel(total); }
}
function carouselPrev() {
  if (carouselIdx > 0) { carouselIdx--; updateCarousel(getConnected().length); }
}

// ═══════════════════════════════════════════════════
//  ALL CASES PAGE
// ═══════════════════════════════════════════════════
let currentFilter = 'all';

function renderAllCases(filter) {
  filter = filter || currentFilter;
  const conn = getConnected();
  const comp = getCompleted().map(r => r.caseId);
  let list = CASES;
  if (filter==='connected')     list = CASES.filter(c => conn.includes(c.id) && !comp.includes(c.id));
  if (filter==='not_connected') list = CASES.filter(c => !conn.includes(c.id));
  if (filter==='completed')     list = CASES.filter(c => comp.includes(c.id));
  document.getElementById('all-case-count').textContent = list.length + ' CASES';
  const grid = document.getElementById('all-cases-grid');
  grid.innerHTML = list.map(c => caseCardHTML(c, comp.includes(c.id), conn.includes(c.id))).join('');
  grid.querySelectorAll('.case-card:not(.locked)').forEach((el, i) => {
    el.addEventListener('click', () => openCaseDetail(list[i].id));
  });
}

function filterCases(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('#case-filter-btns .mode-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  renderAllCases(filter);
}

// ═══════════════════════════════════════════════════
//  CASE DETAIL MODAL
// ═══════════════════════════════════════════════════
function openCaseDetail(caseId) {
  const c = CASES.find(x => x.id === caseId);
  if (!c) return;
  const conn = getConnected();
  const comp = getCompleted().map(r => r.caseId);
  const isConn = conn.includes(caseId);
  const isDone = comp.includes(caseId);
  document.getElementById('modal-case-id').textContent = c.id.toUpperCase() + ' // ' + c.title;
  document.getElementById('modal-case-body').innerHTML = `
    <div style="margin-bottom:14px;">
      <div class="case-thumb" style="background:${c.thumb};height:120px;display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:40px;font-weight:900;color:var(--border2);">
        <div class="case-thumb-overlay"></div>${c.icon}
      </div>
    </div>
    <div class="modal-desc">${c.desc}</div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;font-family:'Share Tech Mono',monospace;font-size:9px;padding:6px 0;border-bottom:1px solid var(--border);">
        <span style="color:var(--text-dim);">STATUS</span>
        <span style="color:${isDone?'var(--ok)':isConn?'var(--accent)':'var(--muted)'};">${isDone?'COMPLETE':isConn?'CONNECTED':'NOT CONNECTED'}</span>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      ${isConn && !isDone ? `<a href="${c.gameUrl}" class="btn-accent" style="padding:10px 16px;">ENTER CASE →</a>` : ''}
      ${!isConn ? `<a href="${c.purchaseUrl}" class="btn-danger" style="padding:10px 16px;">PURCHASE →</a>` : ''}
      ${isDone ? `<span class="btn-save" style="padding:10px 16px;cursor:default;">✓ COMPLETED</span>` : ''}
    </div>`;
  showModal('case-detail');
}

// ═══════════════════════════════════════════════════
//  TRANSMISSIONS
// ═══════════════════════════════════════════════════
function renderTransmissions() {
  const list = document.getElementById('trans-list');
  const readMails = userDoc.readMails || {};
  list.innerHTML = TRANSMISSIONS.map(t => {
    const read = readMails[t.id];
    return `<div class="transmission-item ${!read?'unread':''}" onclick="readMail('${t.id}')">
      <div class="trans-icon">✉</div>
      <div class="trans-body">
        <div class="trans-title">${t.title}</div>
        <div class="trans-preview">${t.preview.slice(0,60)}...</div>
        <div class="trans-meta">FROM: ${t.from} / ${t.date}</div>
      </div>
      ${!read ? '<div class="trans-badge">NEW</div>' : ''}
    </div>`;
  }).join('');
}

async function readMail(id) {
  const readMails = { ...(userDoc.readMails || {}), [id]: true };
  await saveUserDoc({ readMails });
  const t = TRANSMISSIONS.find(x => x.id === id);
  if (!t) return;
  document.getElementById('modal-case-id').textContent = t.title;
  document.getElementById('modal-case-body').innerHTML = `
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-bottom:12px;letter-spacing:.08em;">
      FROM: <em style="color:var(--accent)">${t.from}</em> / ${t.date}
    </div>
    <div class="modal-desc" style="white-space:pre-line;font-size:11px;color:var(--text);">${t.preview}</div>`;
  showModal('case-detail');
  renderTransmissions();
  const unread = TRANSMISSIONS.filter(x => !(userDoc.readMails||{})[x.id]).length;
  const badge = document.getElementById('mail-badge');
  if (unread > 0) { badge.textContent = unread; badge.style.display=''; }
  else { badge.style.display='none'; }
}

// ═══════════════════════════════════════════════════
//  PROFILE
// ═══════════════════════════════════════════════════
async function saveProfile() {
  const name = document.getElementById('pr-name').value.trim();
  if (!name) { showSaveMsg('pr-save-msg','err','✗ エージェント名を入力してください'); return; }
  await saveUserDoc({ name });
  await currentFbUser.updateProfile({ displayName: name });
  document.getElementById('sb-agent-name').textContent = name;
  showSaveMsg('pr-save-msg','ok','✓ プロフィールを保存しました');
  renderProfileStats();
}

function renderProfileStats() {
  const conn = getConnected();
  const comp = getCompleted();
  const hist = getUnlockHist();
  document.getElementById('profile-stats').innerHTML = [
    ['接続済みケース', conn.length + ' / ' + CASES.length],
    ['完了ケース',     comp.length],
    ['解錠コード数',   hist.length],
    ['ゲームモード',   userDoc.mode || 'STANDARD'],
    ['登録日',         userDoc.reg  || '---'],
    ['認証方式',       currentFbUser?.providerData?.[0]?.providerId === 'twitter.com' ? 'X (Twitter)' : 'メール/パスワード'],
  ].map(([l,v]) => `<div class="profile-stat"><div class="profile-stat-lbl">${l}</div><div class="profile-stat-val">${v}</div></div>`).join('');
}

// ═══════════════════════════════════════════════════
//  SERIAL CODE
// ═══════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  const si = document.getElementById('serial-input');
  si.addEventListener('input', e => {
    let v = e.target.value.replace(/[^a-zA-Z0-9]/g,'').toUpperCase();
    if (v.length > 4)  v = v.slice(0,4) + '-' + v.slice(4);
    if (v.length > 9)  v = v.slice(0,9) + '-' + v.slice(9);
    if (v.length > 14) v = v.slice(0,14);
    e.target.value = v;
  });
  si.addEventListener('keydown', e => { if(e.key==='Enter') validateSerial(); });
});

async function validateSerial() {
  const val = document.getElementById('serial-input').value.trim().toUpperCase();
  const resEl = document.getElementById('serial-result');
  if (!val) return;

  if (!SERIAL_DB[val]) {
    resEl.className = 'serial-result err'; resEl.textContent = '✗ 無効なコードです。再確認してください。';
    addLog('err','ERR',`Serial rejected: <em>${val}</em>`); return;
  }

  // Firestoreでコードの使用チェック（グローバル）
  const codeRef = db.collection('usedCodes').doc(val);
  const codeSnap = await codeRef.get();
  if (codeSnap.exists) {
    resEl.className = 'serial-result err'; resEl.textContent = '✗ このコードは既に使用済みです。';
    return;
  }

  const entry = SERIAL_DB[val];
  const conn = [...getConnected()];
  if (!conn.includes(entry.caseId)) conn.push(entry.caseId);

  const now = new Date();
  const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  const hist = [{ code:val, label:entry.label, date:dateStr }, ...getUnlockHist()];

  // Firestoreに保存（コード使用記録＋ユーザーデータ更新を同時に）
  const batch = db.batch();
  batch.set(codeRef, { usedBy: uid(), date: dateStr });
  batch.update(db.collection('users').doc(uid()), { connected: conn, unlockHist: hist });
  await batch.commit();
  userDoc.connected  = conn;
  userDoc.unlockHist = hist;

  resEl.className = 'serial-result ok';
  resEl.textContent = `✓ ${entry.label} を解錠しました`;
  document.getElementById('serial-input').value = '';
  addLog('ok','OK', `Serial accepted: <em>${val}</em> → ${entry.label}`);
  notify(`${entry.label} を解錠しました`, 'ok');
  renderDashboard(); renderAllCases(); renderUnlockHistory(); renderProfileStats(); renderReportCaseSelect();
}

function renderUnlockHistory() {
  const hist = getUnlockHist();
  const el = document.getElementById('unlock-history');
  if (hist.length === 0) { el.textContent = '解錠履歴はありません。'; return; }
  el.innerHTML = hist.map(h => `<span style="color:var(--ok)">✓</span> <em style="color:var(--text)">${h.label}</em> [${h.code}] <span style="color:var(--muted)">${h.date}</span>`).join('<br>');
}

// ═══════════════════════════════════════════════════
//  REPORT
// ═══════════════════════════════════════════════════
function renderReportCaseSelect() {
  const conn = getConnected();
  const comp = getCompleted().map(r => r.caseId);
  const sel = document.getElementById('report-case-select');
  const available = CASES.filter(c => conn.includes(c.id));
  if (available.length === 0) {
    sel.innerHTML = '<option value="">接続済みケースがありません</option>';
  } else {
    sel.innerHTML = available.map(c => {
      const done = comp.includes(c.id);
      return `<option value="${c.id}">${c.id.toUpperCase()} - ${c.title}${done?' [COMPLETE]':''}</option>`;
    }).join('');
  }
}

async function submitReport() {
  const caseId = document.getElementById('report-case-select').value;
  const word   = document.getElementById('report-lastword').value.trim();
  const resEl  = document.getElementById('report-result');
  if (!caseId) { resEl.className='report-result err'; resEl.textContent='✗ ケースを選択してください'; return; }
  if (!word)   { resEl.className='report-result err'; resEl.textContent='✗ ラストワードを入力してください'; return; }
  const c       = CASES.find(x => x.id === caseId);
  const answers = LASTWORD_DB[caseId];
  const correct = answers ? answers.some(a => a.toLowerCase() === word.toLowerCase()) : true;
  const now     = new Date();
  const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

  const newReport = { caseId, word, date:dateStr, status: correct ? 'ACCEPTED' : 'REJECTED' };
  const hist = [newReport, ...getReportHist()];

  if (correct) {
    const comp = getCompleted();
    if (!comp.find(r => r.caseId === caseId)) comp.push({ caseId, word, date:dateStr });
    await saveUserDoc({ completed: comp, reportHist: hist });
    resEl.className='report-result ok'; resEl.textContent='✓ ラストワードを受理しました。ミッション完了。';
    addLog('ok','OK',`Report ACCEPTED: <em>${c?.title}</em> [${word}]`);
    notify(`${c?.title} MISSION COMPLETE`, 'ok');
    document.getElementById('report-lastword').value = '';
    renderDashboard(); renderAllCases(); renderProfileStats(); renderReportCaseSelect();
  } else {
    await saveUserDoc({ reportHist: hist });
    resEl.className='report-result err'; resEl.textContent='✗ ラストワードが一致しません。再調査してください。';
  }
  renderReportHistory();
}

function renderReportHistory() {
  const hist = getReportHist();
  const el = document.getElementById('report-history');
  if (hist.length === 0) { el.textContent = 'レポート送信履歴はありません。'; return; }
  const c_map = {};
  CASES.forEach(c => { c_map[c.id] = c.title; });
  el.innerHTML = hist.map(h => {
    const col = h.status==='ACCEPTED' ? 'var(--ok)' : 'var(--danger)';
    return `<span style="color:${col}">${h.status==='ACCEPTED'?'✓':'✗'}</span> <em style="color:var(--text)">${c_map[h.caseId]||h.caseId}</em> <span style="color:var(--muted)">[${h.word}] ${h.date} ${h.status}</span>`;
  }).join('<br>');
}

// ═══════════════════════════════════════════════════
//  SETTINGS
// ═══════════════════════════════════════════════════
async function setMode(mode) {
  await saveUserDoc({ mode });
  document.getElementById('st-mode').textContent = mode;
  updateModeButtons();
  notify(`ゲームモードを ${mode} に変更しました`, 'info');
}

function updateModeButtons() {
  const mode = userDoc.mode || 'STANDARD';
  ['SOLO','STANDARD','HARD'].forEach(m => {
    const el = document.getElementById('mode-'+m.toLowerCase());
    if (el) el.classList.toggle('selected', mode === m);
  });
}

async function changeEmail() {
  const email = document.getElementById('m-email').value.trim();
  const pass  = document.getElementById('m-email-pass').value;
  if (!email) { notify('メールアドレスを入力してください', 'err'); return; }
  try {
    // 再認証してからメール変更
    const cred = firebase.auth.EmailAuthProvider.credential(currentFbUser.email, pass);
    await currentFbUser.reauthenticateWithCredential(cred);
    await currentFbUser.updateEmail(email);
    await saveUserDoc({ email });
    document.getElementById('pr-email').value = email;
    closeModal();
    notify('メールアドレスを変更しました', 'ok');
  } catch(e) {
    notify('✗ ' + fbErrMsg(e.code), 'err');
  }
}

async function changePassword() {
  const oldP = document.getElementById('m-old-pass').value;
  const newP = document.getElementById('m-new-pass').value;
  if (newP.length < 8) { notify('新しいパスワードは8文字以上必要です', 'err'); return; }
  try {
    const cred = firebase.auth.EmailAuthProvider.credential(currentFbUser.email, oldP);
    await currentFbUser.reauthenticateWithCredential(cred);
    await currentFbUser.updatePassword(newP);
    closeModal();
    notify('パスワードを変更しました', 'ok');
  } catch(e) {
    notify('✗ ' + fbErrMsg(e.code), 'err');
  }
}

async function resetAllData() {
  await saveUserDoc({ connected:[], completed:[], unlockHist:[], reportHist:[] });
  closeModal();
  notify('全データをリセットしました', 'info');
  renderDashboard(); renderAllCases(); renderUnlockHistory(); renderReportHistory(); renderProfileStats(); renderReportCaseSelect();
}

function toggleScanlines(cb) {
  document.body.style.setProperty('--scanline-opacity', cb.checked ? '1' : '0');
}

// ═══════════════════════════════════════════════════
//  SAVE MSG HELPER
// ═══════════════════════════════════════════════════
function showSaveMsg(id, type, msg) {
  const el = document.getElementById(id);
  el.className = 'save-msg ' + type;
  el.textContent = msg;
  setTimeout(() => { el.textContent=''; el.className='save-msg'; }, 3000);
}

// ═══════════════════════════════════════════════════
//  NAV
// ═══════════════════════════════════════════════════
function nav(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('page-label').textContent = page.toUpperCase();
  // highlight nav
  const map = { dashboard:0, cases:1, transmissions:2, profile:5, serial:6, report:7, settings:8 };
  const navItems = document.querySelectorAll('.nav-item:not(.disabled)');
  const idx = map[page];
  if (idx !== undefined && navItems[idx]) navItems[idx].classList.add('active');
  // close sidebar on mobile
  if (window.innerWidth <= 768) {
    document.getElementById('sidebar').classList.remove('open');
  }
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// ═══════════════════════════════════════════════════
//  MODAL
// ═══════════════════════════════════════════════════
function showModal(name) {
  document.getElementById('modal-overlay').style.display = 'flex';
  document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
  const el = document.getElementById('modal-'+name);
  if (el) el.style.display = 'block';
}
function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
}
function closeModalOutside(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

// ═══════════════════════════════════════════════════
//  NOTIFICATION
// ═══════════════════════════════════════════════════
function notify(msg, type='info') {
  const el = document.createElement('div');
  el.className = `notif ${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity='0'; el.style.transition='opacity .4s'; setTimeout(() => el.remove(), 400); }, 3000);
}

// ═══════════════════════════════════════════════════
//  CLOCK
// ═══════════════════════════════════════════════════
function startClock() {
  const tick = () => {
    const n = new Date();
    const h = String(n.getHours()).padStart(2,'0');
    const m = String(n.getMinutes()).padStart(2,'0');
    const s = String(n.getSeconds()).padStart(2,'0');
    const el = document.getElementById('clock');
    if (el) el.textContent = `${h}:${m}:${s}`;
  };
  tick(); setInterval(tick,1000);
}

// ═══════════════════════════════════════════════════
//  LOG FEED
// ═══════════════════════════════════════════════════
const LOG_POOL = [
  ['ok','OK',  'Neural bridge signal stable. Uptime nominal.'],
  ['warn','WARN','Reality anchor degrading. <em>Investigate CASE-002</em>.'],
  ['info','INFO','New case data received from <em>LIMINAL CORE</em>.'],
  ['err','ERR', 'Sector 4 data corruption detected. <em>3 packets lost</em>.'],
  ['ok','OK',  'Agent sync confirmed. All nodes online.'],
  ['info','INFO','Liminal gate oscillation within range.'],
  ['warn','WARN','Anomaly count rising. <em>Immediate action required</em>.'],
  ['ok','OK',  'Transmission log rotated. Archive updated.'],
];
let logIdx = 0;

function startLogFeed() {
  for (let i=0;i<4;i++) pushLog();
  setInterval(pushLog, 3500);
}

function pushLog() {
  const l = LOG_POOL[logIdx % LOG_POOL.length]; logIdx++;
  addLog(l[0], l[1], l[2]);
}

function addLog(cls, level, msg) {
  const body = document.getElementById('log-body');
  if (!body) return;
  const n = new Date();
  const ts = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;
  const line = document.createElement('div');
  line.className = 'log-line';
  line.innerHTML = `<span class
